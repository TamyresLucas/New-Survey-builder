# Survey Builder CI/CD Pipeline
# Builds and deploys the React/TypeScript survey builder application

trigger:
- master

pr:
- master

pool:
  vmImage: 'windows-latest'  # Use Windows for IIS deployment compatibility

variables:
  nodeVersion: '20.x'
  npm_config_cache: $(Pipeline.Workspace)/.npm

stages:
- stage: Build
  displayName: 'Build Application'
  jobs:
  - job: Build
    displayName: 'Build Survey Builder'
    steps:

    # Install Node.js
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js $(nodeVersion)'

    # Cache npm dependencies
    - task: Cache@2
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
        path: $(npm_config_cache)
      displayName: 'Cache npm dependencies'

    # Install dependencies
    - script: |
        npm ci --prefer-offline --no-audit
      displayName: 'Install dependencies'

    # Build application for IIS (with /SurveyBuilderPoc/ base path)
    - script: |
        npm run build:iis
      displayName: 'Build application for IIS'
      env:
        CI: true

    # Copy web.config for IIS deployment
    - script: |
        if exist web.config copy web.config dist\
      displayName: 'Copy web.config to dist (if exists)'

    # Archive dist folder contents to zip (for IIS deployment)
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: 'dist'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/zip-artifacts/survey-builder.zip'
        replaceExistingArchive: true
      displayName: 'Archive build output to zip (IIS)'

    # Build application for Azure App Service (with / base path)
    - script: |
        npm run build:azure
      displayName: 'Build application for Azure App Service'
      env:
        CI: true
        BUILD_TARGET: azure

    # Copy unzipped dist folder for Azure App Service deployment
    - task: CopyFiles@2
      inputs:
        SourceFolder: '.'
        Contents: 'dist/**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/appservice-artifacts'
        CleanTargetFolder: true
      displayName: 'Copy dist folder for Azure App Service'

    # Copy package.json, package-lock.json, and .deployment for Azure App Service
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          package.json
          package-lock.json
          .deployment
        TargetFolder: '$(Build.ArtifactStagingDirectory)/appservice-artifacts'
      displayName: 'Copy package and deployment config for Azure App Service'

    # Publish ZIP artifact (for IIS deployment)
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/zip-artifacts'
        ArtifactName: 'survey-builder-iis'
        publishLocation: 'Container'
      displayName: 'Publish IIS ZIP artifact'

    # Publish unzipped artifact (for Azure App Service deployment)
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/appservice-artifacts'
        ArtifactName: 'survey-builder-appservice'
        publishLocation: 'Container'
      displayName: 'Publish Azure App Service artifact'

    # Publish test results (if tests are added later)
    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '**/test-results.xml'
        testRunTitle: 'Survey Builder Tests'
      condition: succeededOrFailed()
      displayName: 'Publish test results'
